name: Kimi Review Reusable

on:
  workflow_call:
    inputs:
      marker_prefix:
        description: Marker prefix for dedupe comments
        required: false
        type: string
        default: kimi-action-review
    secrets:
      MOONSHOT_API_KEY:
        required: true

permissions:
  contents: read
  pull-requests: write

jobs:
  kimi-review:
    if: ${{ github.event_name == 'pull_request' && !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    env:
      MOONSHOT_API_KEY: ${{ secrets.MOONSHOT_API_KEY }}
      PR_NUMBER: ${{ github.event.pull_request.number }}
      REPO: ${{ github.repository }}
      BASE_SHA: ${{ github.event.pull_request.base.sha }}
      HEAD_SHA: ${{ github.event.pull_request.head.sha }}
      BASE_REF: ${{ github.event.pull_request.base.ref }}
      HEAD_REF: ${{ github.event.pull_request.head.ref }}
      MARKER_PREFIX: ${{ inputs.marker_prefix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build PR diff
        id: diff
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin "$BASE_REF" --quiet || true
          DIFF_CONTENT="$(git diff --unified=2 "$BASE_SHA...$HEAD_SHA" || true)"

          if [ -z "$DIFF_CONTENT" ]; then
            echo "has_diff=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          MAX_CHARS=120000
          if (( ${#DIFF_CONTENT} > MAX_CHARS )); then
            DIFF_CONTENT="${DIFF_CONTENT:0:MAX_CHARS}\n\n[diff truncated]"
          fi

          {
            echo 'DIFF_EOF<<EOF'
            printf '%s\n' "$DIFF_CONTENT"
            echo 'EOF'
          } >> "$GITHUB_ENV"

          echo "has_diff=true" >> "$GITHUB_OUTPUT"

      - name: Skip if already commented for this SHA
        if: steps.diff.outputs.has_diff == 'true'
        id: dedupe
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          MARKER="<!-- ${MARKER_PREFIX}:pr=${PR_NUMBER} sha=${HEAD_SHA} -->"
          if gh api "repos/${REPO}/issues/${PR_NUMBER}/comments" --paginate --jq '.[].body' | grep -Fq "$MARKER"; then
            echo "already_done=true" >> "$GITHUB_OUTPUT"
          else
            echo "already_done=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Request Kimi review
        if: steps.diff.outputs.has_diff == 'true' && steps.dedupe.outputs.already_done != 'true'
        id: kimi
        shell: bash
        run: |
          set -euo pipefail

          PROMPT_HEADER="Este es un Code Review hecho por Kimi k2.5\nPR #${PR_NUMBER} | base: ${BASE_REF} | head: ${HEAD_REF}\n\nRevisa este diff con enfoque en: correctness, regresiones, seguridad y UX edge-cases.\nResponde en markdown breve con:\n- Findings (P1/P2/P3) con archivo y recomendaci√≥n, o\n- Approved si no hay issues.\n\nDIFF:\n"
          PROMPT="${PROMPT_HEADER}${DIFF_EOF}"

          PAYLOAD="$(jq -nc --arg content "$PROMPT" '{model:"kimi-k2.5",temperature:1,messages:[{role:"user",content:$content}]}')"

          RESPONSE="$(curl -sS -X POST https://api.moonshot.ai/v1/chat/completions \
            -H "Authorization: Bearer ${MOONSHOT_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")"

          CONTENT="$(printf '%s' "$RESPONSE" | jq -r '.choices[0].message.content // empty')"
          ERR_MSG="$(printf '%s' "$RESPONSE" | jq -r '.error.message // empty')"

          if [ -z "$CONTENT" ] && [ -n "$ERR_MSG" ]; then
            CONTENT="Kimi review failed: ${ERR_MSG}"
          fi

          if [ -z "$CONTENT" ]; then
            CONTENT="Kimi review: no output (empty response)."
          fi

          CONTENT_LC="$(printf '%s' "$CONTENT" | tr '[:upper:]' '[:lower:]')"
          if [[ "$CONTENT" != Kimi\ review\ failed:* ]] && [[ "$CONTENT" != *"no output (empty response)"* ]]; then
            if echo "$CONTENT_LC" | grep -Eq 'approved|no issues|sin hallazgos|sin findings|looks good|lgtm'; then
              if ! echo "$CONTENT" | grep -Eq '(^|[^A-Z])(P1|P2|P3)([^A-Z]|$)|Findings|Issue:'; then
                CONTENT="Approved"
              fi
            fi
          fi

          {
            echo 'body<<EOF'
            printf '%s\n' "$CONTENT"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Post PR comment
        if: steps.diff.outputs.has_diff == 'true' && steps.dedupe.outputs.already_done != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          MARKER="<!-- ${MARKER_PREFIX}:pr=${PR_NUMBER} sha=${HEAD_SHA} -->"

          COMMENT_FILE="$(mktemp)"
          {
            echo "$MARKER"
            echo
            echo "### Kimi K2.5 Co-Review"
            echo
            printf '%s\n' "${{ steps.kimi.outputs.body }}"
          } > "$COMMENT_FILE"

          gh pr comment "$PR_NUMBER" --repo "$REPO" --body-file "$COMMENT_FILE"
